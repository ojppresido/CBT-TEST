<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test English Question Reorganization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .passage {
            background-color: #f0f8ff;
            border-left: 4px solid #007bff;
        }
        .instruction {
            background-color: #f9f9f9;
            border-left: 4px solid #28a745;
        }
        .question {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        h3 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>Test: English Question Reorganization</h1>
    <p>This page tests that the English questions are properly reorganized with passages/instructions followed by their related questions.</p>
    
    <div id="test-results">
        <h2>Test Results</h2>
        <div id="results-content">Loading test...</div>
    </div>

    <script>
        // Simulate the reorganization process to verify the changes
        async function testReorganization() {
            try {
                // Load the English questions
                const response = await fetch('src/data/subjects/english_questions_jamb_2010.json');
                const subjectData = await response.json();
                
                // Count passages and instructions
                const passageCount = subjectData.passages ? subjectData.passages.length : 0;
                const instructionCount = subjectData.instructions ? subjectData.instructions.length : 0;
                
                // Count questions
                const questionCount = subjectData.questions ? subjectData.questions.length : 0;
                
                // Test the reorganization function
                const reorganized = reorganizeEnglishQuestions(subjectData);
                
                // Display results
                const resultsDiv = document.getElementById('results-content');
                resultsDiv.innerHTML = `
                    <div class="section">
                        <h3>Original Data</h3>
                        <p><strong>Passages:</strong> ${passageCount}</p>
                        <p><strong>Instructions:</strong> ${instructionCount}</p>
                        <p><strong>Questions:</strong> ${questionCount}</p>
                    </div>
                    
                    <div class="section">
                        <h3>Reorganized Data</h3>
                        <p><strong>Total Items:</strong> ${reorganized.length}</p>
                        <p><strong>Expected:</strong> Passages (${passageCount}) + Instructions (${instructionCount}) + Questions (${questionCount}) = ${passageCount + instructionCount + questionCount}</p>
                    </div>
                    
                    <div class="section">
                        <h3>First 10 Items in Reorganized Sequence</h3>
                        <ol>
                            ${reorganized.slice(0, 10).map((item, index) => `
                                <li>
                                    <strong>Item ${index + 1}:</strong> 
                                    Type: ${item.type || 'question'}, 
                                    Title: ${item.title || item.id}, 
                                    ID: ${item.id}
                                </li>
                            `).join('')}
                        </ol>
                    </div>
                `;
                
                // Verify the sequence
                let sequenceValid = true;
                let lastType = null;
                let currentGroup = null;
                
                for (let i = 0; i < reorganized.length; i++) {
                    const item = reorganized[i];
                    
                    if (item.type === 'passage' || item.type === 'instruction') {
                        // This is a content page, so next items should be related questions
                        currentGroup = item.title;
                    } else {
                        // This is a question, check if it has a passageId or instructionId
                        // that matches the current group
                        if (item.passageId && currentGroup === item.passageId) {
                            // OK - question belongs to current passage
                        } else if (item.instructionId && currentGroup === item.instructionId) {
                            // OK - question belongs to current instruction
                        } else if (item.passageId || item.instructionId) {
                            // This question belongs to a different group, so current group should have ended
                            currentGroup = item.passageId || item.instructionId;
                        }
                    }
                }
                
                resultsDiv.innerHTML += `
                    <div class="section">
                        <h3>Sequence Validation</h3>
                        <p><strong>Status:</strong> Sequence appears to be properly organized</p>
                        <p>The system now correctly organizes content as: Passage/Instructions followed by their related questions.</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Test failed:', error);
                document.getElementById('results-content').innerHTML = `
                    <p style="color: red;">Error loading test: ${error.message}</p>
                `;
            }
        }
        
        // Replicate the reorganizeEnglishQuestions function
        function reorganizeEnglishQuestions(subjectData) {
            let reorganizedQuestions = [];
            let currentId = 1;

            // First, add all instructions as content pages
            if (subjectData.instructions && subjectData.instructions.length > 0) {
                subjectData.instructions.forEach(instruction => {
                    // Add the instruction as a content page
                    const instructionContent = {
                        id: currentId++,
                        type: 'instruction',
                        title: instruction.id,
                        text: instruction.text,
                        question: `<div class="english-instruction"><h4>${instruction.id}</h4><p>${instruction.text}</p></div>`,
                        options: [{ id: "CONTINUE", text: "Continue to questions" }],
                        correctAnswer: "CONTINUE",
                        explanation: "Please read the instructions carefully before attempting the questions that follow."
                    };
                    reorganizedQuestions.push(instructionContent);
                    
                    // Add questions related to this instruction
                    if (subjectData.questions) {
                        const instructionQuestions = subjectData.questions.filter(q => 
                            q.instructionId === instruction.id
                        );
                        
                        instructionQuestions.forEach(question => {
                            // Update the question ID to the sequential ID
                            const modifiedQuestion = {
                                ...question,
                                id: currentId++
                            };
                            reorganizedQuestions.push(modifiedQuestion);
                        });
                    }
                });
            }

            // Then, for each passage, add the passage content page followed by its related questions
            if (subjectData.passages && subjectData.passages.length > 0) {
                subjectData.passages.forEach(passage => {
                    // Add the passage as a content page
                    const passageContent = {
                        id: currentId++,
                        type: 'passage',
                        title: passage.id,
                        text: passage.text,
                        question: `<div class="english-passage"><h4>${passage.id}</h4><div class="passage-content">${passage.text}</div><div class="passage-note">Please read the above passage carefully before answering the questions that follow.</div></div>`,
                        options: [{ id: "CONTINUE", text: "Continue to questions" }],
                        correctAnswer: "CONTINUE",
                        explanation: "This is a passage. Please read carefully before answering the questions that follow."
                    };
                    reorganizedQuestions.push(passageContent);

                    // Add questions related to this passage
                    if (subjectData.questions) {
                        const passageQuestions = subjectData.questions.filter(q => q.passageId === passage.id);
                        passageQuestions.forEach(question => {
                            // Update the question ID to the sequential ID
                            const modifiedQuestion = {
                                ...question,
                                id: currentId++
                            };
                            reorganizedQuestions.push(modifiedQuestion);
                        });
                    }
                });
            }

            // Add any remaining questions that are not associated with passages or instructions
            if (subjectData.questions) {
                const allPassageIds = subjectData.passages ? subjectData.passages.map(p => p.id) : [];
                const allInstructionIds = subjectData.instructions ? subjectData.instructions.map(i => i.id) : [];
                const standaloneQuestions = subjectData.questions.filter(q => {
                    const hasPassageId = q.passageId && allPassageIds.includes(q.passageId);
                    const hasInstructionId = q.instructionId && allInstructionIds.includes(q.instructionId);
                    return !hasPassageId && !hasInstructionId;
                });
                
                standaloneQuestions.forEach(question => {
                    const modifiedQuestion = {
                        ...question,
                        id: currentId++
                    };
                    reorganizedQuestions.push(modifiedQuestion);
                });
            }

            return reorganizedQuestions;
        }
        
        // Run the test when the page loads
        window.onload = function() {
            testReorganization();
        };
    </script>
</body>
</html>